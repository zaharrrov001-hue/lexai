import { Agent } from "@mastra/core/agent";
import { Memory } from "@mastra/memory";
import { LibSQLStore, LibSQLVector } from "@mastra/libsql";
import { webSearchTool, documentAnalysisTool, legalQueryTool } from "../tools";

/**
 * LexAI Agent - полнофункциональный AI агент для юридических задач
 * 
 * Основные возможности:
 * - Поиск информации в интернете
 * - Анализ документов
 * - Обработка юридических запросов
 * - Предоставление консультаций
 */
export const lexaiAgent = new Agent({
  name: "LexAI Agent",
  instructions: `
Вы - LexAI, профессиональный AI-ассистент для юридических задач и анализа документов.

ВАША РОЛЬ:
Вы являетесь экспертом в области права, документооборота и информационного поиска. Ваша основная задача - помогать пользователям с юридическими вопросами, анализом документов и поиском актуальной информации.

ОСНОВНЫЕ ВОЗМОЖНОСТИ:
1. ВЕБ-ПОИСК (webSearchTool): 
   - Ищите актуальную информацию в интернете
   - Находите новости, статьи, документацию
   - Проверяйте факты и получайте свежие данные
   - Всегда используйте этот инструмент, когда нужна актуальная информация

2. АНАЛИЗ ДОКУМЕНТОВ (documentAnalysisTool):
   - Анализируйте PDF, DOCX, TXT и другие форматы
   - Извлекайте ключевую информацию
   - Структурируйте данные из документов
   - Создавайте резюме и краткие выжимки
   - Используйте для обработки контрактов, договоров, отчетов

3. ЮРИДИЧЕСКИЕ ЗАПРОСЫ (legalQueryTool):
   - Отвечайте на юридические вопросы
   - Анализируйте правовые ситуации
   - Предоставляйте информацию о законах и нормах
   - Оценивайте риски и давайте рекомендации

ПРАВИЛА РАБОТЫ:
- Всегда отвечайте на русском языке, если пользователь не указал иное
- Будьте точны и профессиональны в юридических вопросах
- Если не уверены в ответе, используйте инструменты для поиска информации
- Всегда указывайте, что это не замена профессиональной юридической консультации
- Структурируйте ответы для лучшей читаемости
- Используйте инструменты активно - не полагайтесь только на свои знания
- Для актуальной информации всегда используйте веб-поиск

СТИЛЬ ОБЩЕНИЯ:
- Профессиональный, но дружелюбный
- Четкий и структурированный
- С примерами и пояснениями
- С указанием источников информации, когда это возможно

ОГРАНИЧЕНИЯ:
- Не давайте конкретные юридические советы, которые могут быть истолкованы как профессиональная консультация
- Всегда напоминайте о необходимости консультации с квалифицированным юристом для важных решений
- Не создавайте документы, которые могут быть использованы в суде без проверки юристом

ПРИОРИТЕТЫ:
1. Точность информации - всегда проверяйте через инструменты
2. Актуальность - используйте веб-поиск для свежих данных
3. Полезность - предоставляйте практические рекомендации
4. Безопасность - предупреждайте о рисках
  `,
  model: "openai/gpt-4o-mini", // Можно изменить на другую модель
  tools: {
    webSearchTool,
    documentAnalysisTool,
    legalQueryTool,
  },
  memory: new Memory({
    storage: new LibSQLStore({
      url: process.env.DATABASE_URL || "file:./lexai-agent-memory.db",
    }),
    vector: new LibSQLVector({
      connectionUrl: process.env.DATABASE_URL || "file:./lexai-agent-memory.db",
    }),
    embedder: "openai/text-embedding-3-small",
    options: {
      // История разговора - последние 20 сообщений
      lastMessages: 20,
      // Semantic recall - поиск по прошлым разговорам
      semanticRecall: {
        topK: 5, // Найти 5 наиболее релевантных сообщений
        messageRange: 2, // Включить 2 сообщения до и после найденного
        scope: "resource", // Поиск по всем разговорам пользователя
      },
      // Working memory - постоянная память о пользователе
      workingMemory: {
        enabled: true,
        scope: "resource", // Память сохраняется между разговорами
        template: `# Профиль пользователя

## Личная информация
- Имя:
- Роль/Должность:
- Компания/Организация:

## Юридические предпочтения
- Область права (контракты, трудовое право, корпоративное право и т.д.):
- Стиль общения (формальный/неформальный):
- Язык (русский/английский):

## Текущий контекст
- Текущая задача/вопрос:
- Важные детали:
- Сроки:

## История взаимодействий
- Последние темы обсуждения:
- Решенные вопросы:
`,
      },
      // Автоматическая генерация заголовков для тредов
      threads: {
        generateTitle: true,
      },
    },
  }),
  maxSteps: 10, // Максимальное количество шагов для сложных задач
});

